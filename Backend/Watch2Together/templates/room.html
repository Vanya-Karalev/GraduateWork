{% extends 'base.html' %}
{% load static %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/room.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/watch.css' %}"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
{% endblock styles %}

{% block content %}
    <div style="display: flex">
        <div class="container show-controls">
            <div class="wrapper">
                <div class="video-timeline">
                    <div class="progress-area">
                        <span>00:00</span>
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <ul class="video-controls">
                    <li class="options left">
                        <button class="volume"><i class="fa-solid fa-volume-high"></i></button>
                        <input type="range" min="0" max="1" step="any">
                        <div class="video-timer">
                            <p class="current-time">00:00</p>
                            <p class="separator"> / </p>
                            <p class="video-duration">00:00</p>
                        </div>
                    </li>
                    <li class="options center">
                        <button class="skip-backward"><i class="fas fa-backward"></i></button>
                        <button class="play-pause"><i class="fas fa-play"></i></button>
                        <button class="skip-forward"><i class="fas fa-forward"></i></button>
                    </li>
                    <li class="options right">
                        <div class="playback-content">
                            <button class="playback-speed"><span class="material-symbols-rounded">slow_motion_video</span></button>
                            <ul class="speed-options">
                                <li data-speed="2">2x</li>
                                <li data-speed="1.5">1.5x</li>
                                <li data-speed="1" class="active">Normal</li>
                                <li data-speed="0.75">0.75x</li>
                                <li data-speed="0.5">0.5x</li>
                            </ul>
                        </div>
                        <button class="pic-in-pic"><span class="material-icons">picture_in_picture_alt</span></button>
                        <button class="fullscreen"><i class="fa-solid fa-expand"></i></button>
                    </li>
                </ul>
            </div>
            {% if is_paused %}
                <video id='video' src="http://media.w3.org/2010/05/sintel/trailer.mp4" poster="https://assets.codepen.io/32795/poster.png" muted></video>
            {% else %}
                <video id='video' src="http://media.w3.org/2010/05/sintel/trailer.mp4" poster="https://assets.codepen.io/32795/poster.png" autoplay muted></video>
            {% endif %}
        </div>
    
        <div class="parent">
            <div class="child-2">
                <center><h2>Chat</h2></center>
                <div class="chat-body-parent">
                    <div class="chat-body" id="tasks">
    
                        <div class="message" id="chatContainer">
                            <!-- Received messages are displayed here -->
                            {% for i in messages %}
                                {% if i.sender != user %}
                                    <div class="receive">
                                        <p style="color: #000;"> {{i.message}}<strong>-{{i.sender}}</strong></p>
                                    </div>
                                {% else %}
                                    <div class="send">
                                        <p style="color: #000;">{{i.message}}</p>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <!-- End of received messages -->
                        </div>
    
                        <div class="form">
                            <form action="" id="message-form" method="POST">
                                {% csrf_token %}
                                <textarea id="msg" cols="30" name="message" rows="10" style="resize: none" placeholder="Enter your message" required></textarea>
                                <button class="submit" type="submit">Send</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block js %}
    {% if request.user == room.owner %}
        <script>
            function scrollToBottom() {
                var chatContainer = document.getElementById("chatContainer");
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        
            // Determine the WebSocket protocol based on the application's URL
            const websocketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
            const wsEndpoint = `${websocketProtocol}://${window.location.host}/ws/notification/{{room_name}}/`;
        
            // Create a new WebSocket connection
            const socket = new WebSocket(wsEndpoint);
        
            // Successful connection event
            socket.onopen = (event) => {
                console.log("WebSocket connection opened!");
            };
        
            // Socket disconnect event
            socket.onclose = (event) => {
                console.log("WebSocket connection closed!");
            };
            
            const container = document.querySelector(".container"),
            mainVideo = container.querySelector("video"),
            videoTimeline = container.querySelector(".video-timeline"),
            progressBar = container.querySelector(".progress-bar"),
            volumeBtn = container.querySelector(".volume i"),
            volumeSlider = container.querySelector(".left input");
            currentVidTime = container.querySelector(".current-time"),
            videoDuration = container.querySelector(".video-duration"),
            skipBackward = container.querySelector(".skip-backward i"),
            skipForward = container.querySelector(".skip-forward i"),
            playPauseBtn = container.querySelector(".play-pause i"),
            speedBtn = container.querySelector(".playback-speed span"),
            speedOptions = container.querySelector(".speed-options"),
            pipBtn = container.querySelector(".pic-in-pic span"),
            fullScreenBtn = container.querySelector(".fullscreen i");
            let timer;
            
            const hideControls = () => {
                if(mainVideo.paused) return;
                timer = setTimeout(() => {
                    container.classList.remove("show-controls");
                }, 3000);
            }
            hideControls();
            
            container.addEventListener("mousemove", () => {
                container.classList.add("show-controls");
                clearTimeout(timer);
                hideControls();
            });
            
            const formatTime = time => {
                let seconds = Math.floor(time % 60),
                minutes = Math.floor(time / 60) % 60,
                hours = Math.floor(time / 3600);
            
                seconds = seconds < 10 ? `0${seconds}` : seconds;
                minutes = minutes < 10 ? `0${minutes}` : minutes;
                hours = hours < 10 ? `0${hours}` : hours;
            
                if(hours == 0) {
                    return `${minutes}:${seconds}`
                }
                return `${hours}:${minutes}:${seconds}`;
            }
            
            videoTimeline.addEventListener("mousemove", e => {
                let timelineWidth = videoTimeline.clientWidth;
                let offsetX = e.offsetX;
                let percent = Math.floor((offsetX / timelineWidth) * mainVideo.duration);
                const progressTime = videoTimeline.querySelector("span");
                offsetX = offsetX < 20 ? 20 : (offsetX > timelineWidth - 20) ? timelineWidth - 20 : offsetX;
                progressTime.style.left = `${offsetX}px`;
                progressTime.innerText = formatTime(percent);
            });
            
            videoTimeline.addEventListener("click", e => {
                let timelineWidth = videoTimeline.clientWidth;
                mainVideo.currentTime = (e.offsetX / timelineWidth) * mainVideo.duration;
                socket.send(JSON.stringify({'timer_state': mainVideo.currentTime, 'room_name': '{{room_name}}'}));
            });
            
            mainVideo.addEventListener("timeupdate", e => {
                let {currentTime, duration} = e.target;
                let percent = (currentTime / duration) * 100;
                progressBar.style.width = `${percent}%`;
                currentVidTime.innerText = formatTime(currentTime);
            });
            
            mainVideo.addEventListener("loadeddata", () => {
                videoDuration.innerText = formatTime(mainVideo.duration);
            });
            
            const draggableProgressBar = e => {
                let timelineWidth = videoTimeline.clientWidth;
                progressBar.style.width = `${e.offsetX}px`;
                mainVideo.currentTime = (e.offsetX / timelineWidth) * mainVideo.duration;
                currentVidTime.innerText = formatTime(mainVideo.currentTime);
                socket.send(JSON.stringify({'timer_state': mainVideo.currentTime, 'room_name': '{{room_name}}'}));
            }
            
            volumeBtn.addEventListener("click", () => {
                if(!volumeBtn.classList.contains("fa-volume-high")) {
                    mainVideo.volume = 0.5;
                    volumeBtn.classList.replace("fa-volume-xmark", "fa-volume-high");
                } else {
                    mainVideo.volume = 0.0;
                    volumeBtn.classList.replace("fa-volume-high", "fa-volume-xmark");
                }
                volumeSlider.value = mainVideo.volume;
            });
            
            volumeSlider.addEventListener("input", e => {
                mainVideo.volume = e.target.value;
                if(e.target.value == 0) {
                    return volumeBtn.classList.replace("fa-volume-high", "fa-volume-xmark");
                }
                volumeBtn.classList.replace("fa-volume-xmark", "fa-volume-high");
            });
            
            speedOptions.querySelectorAll("li").forEach(option => {
                option.addEventListener("click", () => {
                    mainVideo.playbackRate = option.dataset.speed;
                    speedOptions.querySelector(".active").classList.remove("active");
                    option.classList.add("active");
                });
            });
            
            document.addEventListener("click", e => {
                if(e.target.tagName !== "SPAN" || e.target.className !== "material-symbols-rounded") {
                    speedOptions.classList.remove("show");
                }
            });
            
            fullScreenBtn.addEventListener("click", () => {
                container.classList.toggle("fullscreen");
                if(document.fullscreenElement) {
                    fullScreenBtn.classList.replace("fa-compress", "fa-expand");
                    return document.exitFullscreen();
                }
                fullScreenBtn.classList.replace("fa-expand", "fa-compress");
                container.requestFullscreen();
            });
            
            // Form submit listener
            document.getElementById('message-form').addEventListener('submit', function(event){
                event.preventDefault();
                const message = document.getElementById('msg').value;
                socket.send(
                    JSON.stringify({
                        'message': message,
                        'room_name': '{{room_name}}',
                        'sender': '{{user}}',
                    })
                );
            });
        
            // Response from consumer on the server
            socket.addEventListener("message", (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'pause_state') {
                    const isPaused = data.pause_state;
                    console.log('Pause state:', isPaused);
                    if (isPaused) {
                        mainVideo.pause();
                    } else {
                        mainVideo.play();
                    }
                } 
                else if (data.type === 'timer_state') {
                    const timer = data.timer_state;
                    console.log('Timer state:', timer);
                } else {
                    const messageData = data.message;
                    const sender = messageData.sender;
                    const message = messageData.message;
            
                    // Empty the message input field after the message has been sent
                    if (sender === '{{user}}') {
                        document.getElementById('msg').value = '';
                    }
            
                    // Append the message to the chatbox
                    const messageDiv = document.querySelector('.message');
                    if (sender !== '{{user}}') {
                        messageDiv.innerHTML += '<div class="receive"><p style="color: #000;">' + message + '<strong>-' + sender + '</strong></p></div>';
                    } else {
                        messageDiv.innerHTML += '<div class="send"><p style="color: #000;">' + message + '</p></div>';
                    }
                    scrollToBottom();
                }
            });
            
            speedBtn.addEventListener("click", () => speedOptions.classList.toggle("show"));
            pipBtn.addEventListener("click", () => mainVideo.requestPictureInPicture());
            skipBackward.addEventListener("click", () => {
                mainVideo.currentTime -= 5
                socket.send(JSON.stringify({'timer_state': mainVideo.currentTime, 'room_name': '{{room_name}}'}));
            });
            skipForward.addEventListener("click", () => {
                mainVideo.currentTime += 5
                socket.send(JSON.stringify({'timer_state': mainVideo.currentTime, 'room_name': '{{room_name}}'}));
            });
            mainVideo.addEventListener("play", () => {
                playPauseBtn.classList.replace("fa-play", "fa-pause");
                // Отправить данные о начале воспроизведения через сокеты
                socket.send(JSON.stringify({'pause_state': false, 'room_name': '{{room_name}}'}));
                socket.send(JSON.stringify({'timer_state': mainVideo.currentTime, 'room_name': '{{room_name}}'}));
            });
            {#mainVideo.addEventListener("play", () => playPauseBtn.classList.replace("fa-play", "fa-pause"));#}
            {#mainVideo.addEventListener("pause", () => playPauseBtn.classList.replace("fa-pause", "fa-play"));#}
            mainVideo.addEventListener("pause", () => {
                playPauseBtn.classList.replace("fa-pause", "fa-play");
                socket.send(JSON.stringify({'pause_state': true, 'room_name': '{{room_name}}'}));
                socket.send(JSON.stringify({'timer_state': mainVideo.currentTime, 'room_name': '{{room_name}}'}));
            });
            playPauseBtn.addEventListener("click", () => mainVideo.paused ? mainVideo.play() : mainVideo.pause());
            videoTimeline.addEventListener("mousedown", () => videoTimeline.addEventListener("mousemove", draggableProgressBar));
            document.addEventListener("mouseup", () => videoTimeline.removeEventListener("mousemove", draggableProgressBar));
        </script>
    {% else %}
        <script>
            function scrollToBottom() {
                var chatContainer = document.getElementById("chatContainer");
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        
            // Determine the WebSocket protocol based on the application's URL
            const websocketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
            const wsEndpoint = `${websocketProtocol}://${window.location.host}/ws/notification/{{room_name}}/`;
        
            // Create a new WebSocket connection
            const socket = new WebSocket(wsEndpoint);
        
            // Successful connection event
            socket.onopen = (event) => {
                console.log("WebSocket connection opened!");
            };
        
            // Socket disconnect event
            socket.onclose = (event) => {
                console.log("WebSocket connection closed!");
            };
            
            const container = document.querySelector(".container"),
            mainVideo = container.querySelector("video"),
            videoTimeline = container.querySelector(".video-timeline"),
            progressBar = container.querySelector(".progress-bar"),
            volumeBtn = container.querySelector(".volume i"),
            volumeSlider = container.querySelector(".left input");
            currentVidTime = container.querySelector(".current-time"),
            videoDuration = container.querySelector(".video-duration"),
            skipBackward = container.querySelector(".skip-backward i"),
            skipForward = container.querySelector(".skip-forward i"),
            playPauseBtn = container.querySelector(".play-pause i"),
            speedBtn = container.querySelector(".playback-speed span"),
            speedOptions = container.querySelector(".speed-options"),
            pipBtn = container.querySelector(".pic-in-pic span"),
            fullScreenBtn = container.querySelector(".fullscreen i");
            let timer;
            
            const hideControls = () => {
                if(mainVideo.paused) return;
                timer = setTimeout(() => {
                    container.classList.remove("show-controls");
                }, 3000);
            }
            hideControls();
            
            container.addEventListener("mousemove", () => {
                container.classList.add("show-controls");
                clearTimeout(timer);
                hideControls();
            });
            
            const formatTime = time => {
                let seconds = Math.floor(time % 60),
                minutes = Math.floor(time / 60) % 60,
                hours = Math.floor(time / 3600);
            
                seconds = seconds < 10 ? `0${seconds}` : seconds;
                minutes = minutes < 10 ? `0${minutes}` : minutes;
                hours = hours < 10 ? `0${hours}` : hours;
            
                if(hours == 0) {
                    return `${minutes}:${seconds}`
                }
                return `${hours}:${minutes}:${seconds}`;
            }
            
            {#videoTimeline.addEventListener("mousemove", e => {#}
            {#    let timelineWidth = videoTimeline.clientWidth;#}
            {#    let offsetX = e.offsetX;#}
            {#    let percent = Math.floor((offsetX / timelineWidth) * mainVideo.duration);#}
            {#    const progressTime = videoTimeline.querySelector("span");#}
            {#    offsetX = offsetX < 20 ? 20 : (offsetX > timelineWidth - 20) ? timelineWidth - 20 : offsetX;#}
            {#    progressTime.style.left = `${offsetX}px`;#}
            {#    progressTime.innerText = formatTime(percent);#}
            {#});#}
            {##}
            {#videoTimeline.addEventListener("click", e => {#}
            {#    let timelineWidth = videoTimeline.clientWidth;#}
            {#    mainVideo.currentTime = (e.offsetX / timelineWidth) * mainVideo.duration;#}
            {#});#}
            
            mainVideo.addEventListener("timeupdate", e => {
                let {currentTime, duration} = e.target;
                let percent = (currentTime / duration) * 100;
                progressBar.style.width = `${percent}%`;
                currentVidTime.innerText = formatTime(currentTime);
            });
            
            mainVideo.addEventListener("loadeddata", () => {
                videoDuration.innerText = formatTime(mainVideo.duration);
            });
            
            {#const draggableProgressBar = e => {#}
            {#    let timelineWidth = videoTimeline.clientWidth;#}
            {#    progressBar.style.width = `${e.offsetX}px`;#}
            {#    mainVideo.currentTime = (e.offsetX / timelineWidth) * mainVideo.duration;#}
            {#    currentVidTime.innerText = formatTime(mainVideo.currentTime);#}
            {#}#}
            
            volumeBtn.addEventListener("click", () => {
                if(!volumeBtn.classList.contains("fa-volume-high")) {
                    mainVideo.volume = 0.5;
                    volumeBtn.classList.replace("fa-volume-xmark", "fa-volume-high");
                } else {
                    mainVideo.volume = 0.0;
                    volumeBtn.classList.replace("fa-volume-high", "fa-volume-xmark");
                }
                volumeSlider.value = mainVideo.volume;
            });
            
            volumeSlider.addEventListener("input", e => {
                mainVideo.volume = e.target.value;
                if(e.target.value == 0) {
                    return volumeBtn.classList.replace("fa-volume-high", "fa-volume-xmark");
                }
                volumeBtn.classList.replace("fa-volume-xmark", "fa-volume-high");
            });
            
            speedOptions.querySelectorAll("li").forEach(option => {
                option.addEventListener("click", () => {
                    mainVideo.playbackRate = option.dataset.speed;
                    speedOptions.querySelector(".active").classList.remove("active");
                    option.classList.add("active");
                });
            });
            
            document.addEventListener("click", e => {
                if(e.target.tagName !== "SPAN" || e.target.className !== "material-symbols-rounded") {
                    speedOptions.classList.remove("show");
                }
            });
            
            fullScreenBtn.addEventListener("click", () => {
                container.classList.toggle("fullscreen");
                if(document.fullscreenElement) {
                    fullScreenBtn.classList.replace("fa-compress", "fa-expand");
                    return document.exitFullscreen();
                }
                fullScreenBtn.classList.replace("fa-expand", "fa-compress");
                container.requestFullscreen();
            });
            
            // Form submit listener
            document.getElementById('message-form').addEventListener('submit', function(event){
                event.preventDefault();
                const message = document.getElementById('msg').value;
                socket.send(
                    JSON.stringify({
                        'message': message,
                        'room_name': '{{room_name}}',
                        'sender': '{{user}}',
                    })
                );
            });
        
            // Response from consumer on the server
            socket.addEventListener("message", (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'pause_state') {
                    let isPaused = data.pause_state;
                    console.log('Pause state:', isPaused);
                    if (isPaused) {
                        mainVideo.pause();
                    } else {
                        mainVideo.play();
                    }
                } else if (data.type === 'timer_state') {
                    let timer = data.timer_state;
                    console.log('Timer state:', timer);
                    mainVideo.currentTime = data.timer_state;
                } else {
                    const messageData = data.message;
                    const sender = messageData.sender;
                    const message = messageData.message;
            
                    // Empty the message input field after the message has been sent
                    if (sender === '{{user}}') {
                        document.getElementById('msg').value = '';
                    }
            
                    // Append the message to the chatbox
                    const messageDiv = document.querySelector('.message');
                    if (sender !== '{{user}}') {
                        messageDiv.innerHTML += '<div class="receive"><p style="color: #000;">' + message + '<strong>-' + sender + '</strong></p></div>';
                    } else {
                        messageDiv.innerHTML += '<div class="send"><p style="color: #000;">' + message + '</p></div>';
                    }
                    scrollToBottom();
                }
            });
            
            {#speedBtn.addEventListener("click", () => speedOptions.classList.toggle("show"));#}
            pipBtn.addEventListener("click", () => mainVideo.requestPictureInPicture());
            {#skipBackward.addEventListener("click", () => mainVideo.currentTime -= 5);#}
            {#skipForward.addEventListener("click", () => mainVideo.currentTime += 5);#}
            mainVideo.addEventListener("play", () => playPauseBtn.classList.replace("fa-play", "fa-pause"));
            mainVideo.addEventListener("pause", () => playPauseBtn.classList.replace("fa-pause", "fa-play"));
            {#playPauseBtn.addEventListener("click", () => mainVideo.paused ? mainVideo.play() : mainVideo.pause());#}
            {#videoTimeline.addEventListener("mousedown", () => videoTimeline.addEventListener("mousemove", draggableProgressBar));#}
            {#document.addEventListener("mouseup", () => videoTimeline.removeEventListener("mousemove", draggableProgressBar));#}
        </script>
    {% endif %}
{% endblock js %}
